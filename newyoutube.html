
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Wikiblurb | 9bit Studios</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
</head>

<body>

<h1>Wikiblurb</h1>
	
<div id="article"></div>
<div id="otherWikiArticle"></div>

<script src="js/jquery.wikiblurb.js" type="text/javascript"></script>
<script type="text/javascript">

(function ($) {

    $.fn.wikiblurb = function (options) {

        var defaults = $.extend({
	    wikiURL: "http://en.wikipedia.org/",
	    apiPath: 'w',
	    section: 0,
	    page: 'Jimi_Hendrix',
	    removeLinks: false,	    
	    type: 'all',
	    customSelector: '',
		filterSelector: ''
        }, options);
        
	/******************************
	Private Variables
	*******************************/         

	var object = $(this);
	var settings = $.extend(defaults, options);
	
	/******************************
	Public Methods
	*******************************/         
        
        var methods = {
        	
	    init: function() {
		return this.each(function () {
		    methods.appendHTML();
		    methods.initializeItems();
		});
	    },
			
	    /******************************
	    Append HTML
	    *******************************/			

	    appendHTML: function() {
		// nothiing to append
	    },

	    /******************************
	    Initialize
	    *******************************/			

	    initializeItems: function() {
		$.ajax({
		    type: "GET",
		    url: settings.wikiURL + settings.apiPath + "/api.php?action=parse&format=json&prop=text&section="+settings.section+"&page="+settings.page+"&callback=?",
		    contentType: "application/json; charset=utf-8",
		    async: false,
		    dataType: "json",
		    success: function (data, textStatus, jqXHR) {

			try {
			    var markup = data.parse.text["*"];
			    var blurb = $('<div class="nbs-wikiblurb"></div>').html(markup);

			    // remove links?

			    if(settings.removeLinks) {
				blurb.find('a').each(function() { 
				    $(this).replaceWith($(this).html()); 
				});
			    }
			    else {
				blurb.find('a').each(function() {
				    var link = $(this);
				    var relativePath = link.attr('href').substring(1); // remove leading slash
				    link.attr('href', settings.wikiURL + relativePath); 
				});			    
			    }

			    // remove any references
			    blurb.find('sup').remove();

			    // remove cite error
			    blurb.find('.mw-ext-cite-error').remove();

				// filter elements
				if(settings.filterSelector) blurb.find(settings.filterSelector).remove();

			    switch(settings.type) {
				case 'text':				
				    object.html($(blurb).find('p'));
				    break;
				    
				case 'blurb':
				    object.html($(blurb).find('p:first'));
				    break;
				
				case 'infobox':
				    object.html($(blurb).find('.vcard'));
				    break;
				    
				case 'custom':
				    object.html($(blurb).find(settings.customSelector));
				    break;
				
				default:
				    object.html(blurb);
				    break;
			    }
				
			}
			catch(e){
			    methods.showError();
			}
			
		    },
		    error: function (jqXHR, textStatus, errorThrown) {
			methods.showError();
		    }
		});
	    },
	    
	    showError: function(){
		object.html('<div class="nbs-wikiblurb-error">There was an error locating your wiki data</div>');
	    }

        };
        
        if (methods[options]) { // $("#element").pluginName('methodName', 'arg1', 'arg2');
            return methods[options].apply(this, Array.prototype.slice.call(arguments, 1));
        } else if (typeof options === 'object' || !options) { 	// $("#element").pluginName({ option: 1, option:2 });
            return methods.init.apply(this);  
        } else {
            $.error( 'Method "' +  method + '" does not exist in wikiblurb plugin!');
        } 
    };

})(jQuery);

</script>

  
</body>
</html>